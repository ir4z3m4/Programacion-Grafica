<!DOCTYPE HTML>
<html>
<head>
  <title>Textura 2D en WebGL 2.0</title>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
</head>
   <body>
      <h2>Textura 2D en WebGL 2.0</h2>
        <canvas id="webglcanvas" width="500" height="500"></canvas>

        <img src="fondo.jpg" id="fondoImg" hidden>
        <img src="nave.png" id="naveImg" hidden>
        <img src="naveE.png" id="naveEImg" hidden>
        <img src="jedi.png" id="monedaImg" hidden>
        <img src="laser.png" id="laserImg" hidden>

        <div>
     <button id="disparar">Disparar</button>
</div>
<div>
  <p>Naves destruidas: <span id="contadorEnemigos">0</span></p>
  <p>Impactos: <span id="contadorImpactos">0</span></p>
</div>

<script id="vs" type="vertex">
#version 300 es
uniform vec2 uDesplaza;
uniform vec2 uEscala;
uniform mat4 uMatrizProyeccion;
layout(location = 0) in vec2 aVertices;
layout(location = 1) in vec2 aCoordenadasDeTextura;
out vec2 vCoordenadasDeTextura;
void main() {
  vCoordenadasDeTextura = aCoordenadasDeTextura;
  vec2 vertices = aVertices * uEscala + uDesplaza;
  gl_Position = uMatrizProyeccion * vec4(vertices, 0.0, 1.0);
}
</script>

<script id="fs" type="fragment">
#version 300 es
precision mediump float;
uniform sampler2D uUnidadDeTextura;
in vec2 vCoordenadasDeTextura;
out vec4 color;
void main() {
  color = texture(uUnidadDeTextura, vCoordenadasDeTextura);
}
</script>

<script>
var canvas, gl;
var uDesplaza, uEscala, uMatrizProyeccion, uUnidadDeTextura;
var MatrizProyeccion = new Array(16);

var destinoX = 0;
var velocidadNave = 0.5;
var velocidadLaser = 1.0;
var enemigosDestruidos = 0;
var impactos = 0;
var juegoTerminado = false;

var nave, naveE, moneda, lasers = [];

var sonidoDisparo = new Audio('disparo.mp3');
var sonidoExplosion = new Audio('explosion.mp3');
var sonidoColision = new Audio('colision.mp3');
var sonidoCrecimiento = new Audio('crecimiento.mp3');

function colisionRR(a, b) {
  return a.x < b.x + b.ancho && a.x + a.ancho > b.x &&
         a.y < b.y + b.alto && a.y + a.alto > b.y;
}

function mouseDown(e){
  destinoX = e.offsetX * 100 / canvas.width - 50;
}

function dispararLaser(){
  lasers.push({ x: nave.x, y: nave.y + nave.alto/2, ancho: 3, alto: 6 }); // lasers más grandes
  sonidoDisparo.currentTime = 0;
  sonidoDisparo.play();
}

function Rectangulo(gl, x1, y1, x2, y2, idImagen){
  this.vao = gl.createVertexArray();
  gl.bindVertexArray(this.vao);

  var vertices = [ x1,y1, x2,y1, x2,y2, x1,y2 ];
  var tex = [0,0, 1,0, 1,1, 0,1];

  var vb = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, vb);
  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(vertices), gl.STATIC_DRAW);
  gl.enableVertexAttribArray(0);
  gl.vertexAttribPointer(0,2,gl.FLOAT,false,0,0);

  var tb = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, tb);
  gl.bufferData(gl.ARRAY_BUFFER, new Float32Array(tex), gl.STATIC_DRAW);
  gl.enableVertexAttribArray(1);
  gl.vertexAttribPointer(1,2,gl.FLOAT,false,0,0);

  gl.bindVertexArray(null);
  gl.bindBuffer(gl.ARRAY_BUFFER,null);

  this.textura = gl.createTexture();
  gl.bindTexture(gl.TEXTURE_2D,this.textura);
  gl.pixelStorei(gl.UNPACK_FLIP_Y_WEBGL,true);
  var img = document.getElementById(idImagen);
  gl.texImage2D(gl.TEXTURE_2D,0,gl.RGBA,gl.RGBA,gl.UNSIGNED_BYTE,img);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_S,gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_WRAP_T,gl.CLAMP_TO_EDGE);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MIN_FILTER,gl.LINEAR);
  gl.texParameteri(gl.TEXTURE_2D,gl.TEXTURE_MAG_FILTER,gl.LINEAR);
  gl.bindTexture(gl.TEXTURE_2D,null);

  this.dibuja = function(gl, escX, escY, posX, posY){
    gl.bindVertexArray(this.vao);
    gl.uniform2f(uEscala, escX, escY);
    gl.uniform2f(uDesplaza, posX, posY);
    gl.activeTexture(gl.TEXTURE0);
    gl.bindTexture(gl.TEXTURE_2D,this.textura);
    gl.uniform1i(uUnidadDeTextura,0);
    gl.drawArrays(gl.TRIANGLE_FAN,0,4);
    gl.bindVertexArray(null);
  };
}

var fondoRect, naveRect, naveERect, monedaRect, laserRect;

function FinJuego(){
  if(juegoTerminado) return true;
  if(impactos >=3){
    juegoTerminado = true;
    alert("¡Perdiste! Tu nave se redujo demasiado.");
    return true;
  }
  if(enemigosDestruidos >=5){
    juegoTerminado = true;
    alert("¡Ganaste! Has destruido suficientes enemigos.");
    return true;
  }
  return false;
}

function dibuja(){
  if(FinJuego()) return;

  gl.clear(gl.COLOR_BUFFER_BIT);

  fondoRect.dibuja(gl,50,50,0,0);

  if(Math.abs(destinoX - nave.x) > velocidadNave){
    nave.x += (destinoX>nave.x)? velocidadNave : -velocidadNave;
  }

  if(naveE.visible && colisionRR(nave,naveE)){
    impactos++;
    document.getElementById("contadorImpactos").textContent = impactos;
    sonidoColision.currentTime=0; sonidoColision.play();
    nave.ancho *=0.8; nave.alto*=0.8;
    naveE.visible=false;
  }

  naveRect.dibuja(gl,nave.ancho/2,nave.alto/2,nave.x,nave.y);

  for(var i=0;i<lasers.length;i++){
    var l = lasers[i];
    l.y += velocidadLaser;
    laserRect.dibuja(gl,l.ancho/2,l.alto/2,l.x,l.y);
    if(naveE.visible && colisionRR(l,naveE)){
      enemigosDestruidos++;
      document.getElementById("contadorEnemigos").textContent=enemigosDestruidos;
      sonidoExplosion.currentTime=0; sonidoExplosion.play();
      naveE.visible=false;
      lasers.splice(i,1); i--;
    }
  }

  if(naveE.visible) naveE.y -=0.3;
  if(!naveE.visible || naveE.y+naveE.alto/2 < -50){
    var spawnRange=100-naveE.ancho;
    naveE.x = Math.random()*spawnRange-50+naveE.ancho/2;
    naveE.y = 50; naveE.visible=true;
  }

  if(naveE.visible) naveERect.dibuja(gl,naveE.ancho/2,naveE.alto/2,naveE.x,naveE.y);

  if(moneda.visible) moneda.y -= moneda.velocidad;
  if(moneda.visible){
    monedaRect.dibuja(gl,moneda.ancho/2,moneda.alto/2,moneda.x,moneda.y);
    if(colisionRR(nave,moneda)){
      sonidoCrecimiento.currentTime=0; sonidoCrecimiento.play();
      nave.ancho*=1.2; nave.alto*=1.2;
      moneda.visible=false;
    }
  }
  if(!moneda.visible || moneda.y+moneda.alto/2< -50){
    var spawnRangeM = 100-moneda.ancho;
    moneda.x = Math.random()*spawnRangeM -50 + moneda.ancho/2;
    moneda.y=50; moneda.visible=true;
  }

  requestAnimationFrame(dibuja);
}

function main(){
  canvas = document.getElementById("webglcanvas");
  gl = canvas.getContext("webgl2");
  gl.viewport(0,0,canvas.width,canvas.height);
  gl.clearColor(0,0,0,1);
  gl.enable(gl.BLEND);
  gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

  var vs = gl.createShader(gl.VERTEX_SHADER);
  gl.shaderSource(vs, document.getElementById("vs").text.trim());
  gl.compileShader(vs);

  var fs = gl.createShader(gl.FRAGMENT_SHADER);
  gl.shaderSource(fs, document.getElementById("fs").text.trim());
  gl.compileShader(fs);

  var programa = gl.createProgram();
  gl.attachShader(programa, vs); gl.attachShader(programa, fs);
  gl.linkProgram(programa);
  gl.useProgram(programa);

  uDesplaza = gl.getUniformLocation(programa,"uDesplaza");
  uEscala = gl.getUniformLocation(programa,"uEscala");
  uMatrizProyeccion = gl.getUniformLocation(programa,"uMatrizProyeccion");
  uUnidadDeTextura = gl.getUniformLocation(programa,"uUnidadDeTextura");

  for(var i=0;i<16;i++) MatrizProyeccion[i]=0;
  MatrizProyeccion[0]=0.02; MatrizProyeccion[5]=0.02; MatrizProyeccion[10]=1; MatrizProyeccion[15]=1;
  gl.uniformMatrix4fv(uMatrizProyeccion,false,new Float32Array(MatrizProyeccion));

  fondoRect = new Rectangulo(gl,-1,-1,1,1,"fondoImg");
  naveRect = new Rectangulo(gl,-1,-1,1,1,"naveImg");
  naveERect = new Rectangulo(gl,-1,-1,1,1,"naveEImg");
  monedaRect = new Rectangulo(gl,-1,-1,1,1,"monedaImg");
  laserRect = new Rectangulo(gl,-0.2,-0.8,0.2,0.8,"laserImg");

  nave={x:0,y:-40,ancho:20,alto:10};
  naveE={x:0,y:45,ancho:8,alto:8,visible:true};
  moneda={x:20,y:50,ancho:5,alto:5,visible:true,velocidad:0.3};

  canvas.addEventListener("mousedown",mouseDown);
  document.getElementById("disparar").addEventListener("click",dispararLaser);

  sonidoDisparo.volume=0.5;
  sonidoExplosion.volume=0.5;
  sonidoColision.volume=0.5;
  sonidoCrecimiento.volume=0.5;

  dibuja();
}

window.onload = main;
</script>
</body>
</html>

 
